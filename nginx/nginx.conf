worker_processes auto;           
worker_rlimit_nofile 65535;

events {
    worker_connections 4096;
    use epoll;                   
    multi_accept on;
}

http {
    upstream pixel_backend {
        least_conn;                          
        server 127.0.0.1:8001;              
        server 172.31.25.176:8000;
        keepalive 128;                       
        keepalive_requests 10000;
        keepalive_timeout 60s;
    }

    sendfile            on;
    tcp_nopush          on;
    tcp_nodelay         on;
    keepalive_timeout   65;
    keepalive_requests  10000;

    proxy_connect_timeout   5s;
    proxy_send_timeout      30s;
    proxy_read_timeout      30s;
    proxy_buffering         off;            

    gzip off;

    server {
        listen 8000 reuseport;

        location = /pixel {
            proxy_pass http://pixel_backend;
            proxy_http_version 1.1;        
            proxy_set_header Connection ""; 
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
        }

        location = /pixels {
            proxy_pass http://pixel_backend;
            proxy_http_version 1.1;
            proxy_set_header Connection "";
        }

        location = /health {
            access_log off;
            return 200 '{"status":"healthy"}';
            add_header Content-Type application/json;
        }
    }
}